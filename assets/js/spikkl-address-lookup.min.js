jQuery(document).ready(function(e){if("undefined"==typeof spikkl_params)return!1;const t=new RegExp("^[1-9][0-9]{3}\\s*(?!sa|sd|ss)[a-z]{2}$","i"),s=new RegExp("^[0-9]{1,5}$"),i=new RegExp("^(?:[a-z])?(?:\\s?[a-z0-9]{1,4})?$","i"),r=function(t){this.cache={},this.xhr=null,this.lookupTimeout=null,this.prefix=t.prefix,this.$countryField=e(t.country+"_field"),this.$stateField=e(t.state+"_field"),this.$cityField=e(t.city+"_field"),this.$address1Field=e(t.address_1+"_field"),this.$address2Field=e(t.address_2+"_field"),this.$streetField=e(t.street+"_field"),this.$postcodeField=e(t.postcode+"_field"),this.$streetNumberField=e(t.street_number+"_field"),this.$streetNumberSuffixField=e(t.street_number_suffix+"_field"),this.$country=this.$countryField.find(":input"),this.$state=this.$stateField.find(":input"),this.$city=this.$cityField.find(":input"),this.$address1=this.$address1Field.find(":input"),this.$address2=this.$address2Field.find(":input"),this.$street=this.$streetField.find(":input"),this.$postcode=this.$postcodeField.find(":input"),this.$streetNumber=this.$streetNumberField.find(":input"),this.$streetNumberSuffix=this.$streetNumberSuffixField.find(":input"),this.isCheckout()&&(this.setHelperElements(),this.$country.on("change",()=>{this.setupFields()}),this.setupFields(t.prefix))};r.prototype.setupFields=function(e){let t=this.getSelectedCountryCode();this.reorderFields(t),this.listen(t),this.autoFillMyParcelFields(e)},r.prototype.listen=function(e){this.isCountryEligibleForLookup(e)?(this.$postcode.on("blur input",this.debounce(this.validatePostcode,250)),this.$streetNumber.on("blur input",this.debounce(this.validateStreetNumber,250)),this.$streetNumberSuffix.on("blur input",this.debounce(this.validateStreetNumberSuffix,250)),this.applyFieldsLock()):(this.$postcode.off("blur input"),this.$streetNumber.off("blur input"),this.$streetNumberSuffix.off("blur input"),this.hardResetFields(),this.releaseFieldsLock())},r.prototype.autoFillMyParcelFields=function(t){e(document.body).on("update_checkout",()=>{e("#"+t+"_street_name_field").find(":input").val(this.$street.val()),e("#"+t+"_house_number_field").find(":input").val(this.$streetNumber.val()),e("#"+t+"_house_number_suffix_field").find(":input").val(this.$streetNumberSuffix.val())})},r.prototype.applyFieldsLock=function(){this.$postcode.attr("autocomplete","off"),this.$postcode.attr("maxlength",7),this.$street.attr("readonly",!0),this.$city.attr("readonly",!0),this.$state.attr("readonly",!0),this.$stateField.addClass("spikkl-hidden")},r.prototype.releaseFieldsLock=function(){this.$postcode.removeAttr("autocomplete"),this.$postcode.removeAttr("maxlength"),this.$street.removeAttr("readonly"),this.$city.removeAttr("readonly"),this.$state.removeAttr("readonly"),this.$stateField.removeClass("spikkl-hidden")},r.prototype.softResetFields=function(){this.$street.val(""),this.$city.val(""),this.$state.val("").trigger("change"),void 0!==this.$spinner&&this.stopLoading()},r.prototype.hardResetFields=function(){this.$postcode.val(""),this.$streetNumber.val(""),this.$streetNumberSuffix.val(""),void 0!==this.$message&&this.$message.hide(),this.softResetFields()},r.prototype.debounce=function(e,t=450){let s;const i=this;return function(){clearTimeout(s),s=setTimeout(function(){s=null,e.apply(i)},t)}},r.prototype.performLookup=function(){if(!this.isValidPostcode()||!this.isValidStreetNumber()||!this.isValidStreetNumberSuffix())return void this.softResetFields();const e=this.$postcode.val(),t=this.$streetNumber.val(),s=this.$streetNumberSuffix.val();this.startLoading(),this.$message.hide();const i={action:spikkl_params.action,postal_code:encodeURIComponent(e),street_number:encodeURIComponent(t),street_number_suffix:encodeURIComponent(s)};this.cachedGet(i)},r.prototype.cachedGet=function(t){const s=spikkl_params.url+JSON.stringify(Object.values(t));this.xhr&&this.xhr.abort(),this.cache.hasOwnProperty(s)?this.fillFields(this.cache[s]):this.xhr=e.ajax({crossDomain:!0,type:"GET",dataType:"json",timeout:5e3,url:spikkl_params.url,data:t,success:(e,t)=>{if(!e||"success"!==t)return this.fillFields({status:"failed",status_code:"UNAVAILABLE"}),void this.releaseFieldsLock();this.cache[s]=e,this.fillFields(e)}})},r.prototype.startLoading=function(){this.$spinner.show(),this.$postcode.attr("disabled",!0),this.$streetNumber.attr("disabled",!0),this.$streetNumberSuffix.attr("disabled",!0)},r.prototype.stopLoading=function(){this.$spinner.hide(),this.$postcode.attr("disabled",!1),this.$streetNumber.attr("disabled",!1),this.$streetNumberSuffix.attr("disabled",!1)},r.prototype.fillFields=function(e){if(this.stopLoading(),"ok"===e.status&&e.results.length>=1)this.fillDefaultFields(e.results[0]);else{let t;"ZERO_RESULTS"===e.status_code&&(t=spikkl_params.errors.invalid_address),"INVALID_REQUEST"===e.status_code&&(t=spikkl_params.errors.invalid_postal_code_or_street_number),"UNAVAILABLE"!==e.status_code&&"ACCESS_RESTRICTED"!==e.status_code||(t=spikkl_params.errors.unknown_error,this.releaseFieldsLock()),this.softResetFields(),this.$message.empty().append("<li>"+t+"</li>"),this.$message.show()}},r.prototype.fillDefaultFields=function(e){this.$postcode.val(e.postal_code).change(),this.$street.val(e.street_name).change(),this.$streetNumber.val(e.street_number).change(),this.$streetNumberSuffix.val(e.street_number_suffix).change(),this.$city.val(e.city).change(),this.$state.val(e.administrative_areas[0].abbreviation).change()},r.prototype.validatePostcode=function(){const e=this.$postcode.val();this.$message.hide(),null!==e&&""!==e&&(t.test(e)?(this.$postcodeField.removeClass("woocommerce-invalid"),this.$postcode.is(":focus")||this.performLookup()):this.$postcodeField.addClass("woocommerce-invalid"))},r.prototype.validateStreetNumber=function(){const e=this.$streetNumber.val();this.$message.hide(),null!==e&&""!==e&&(s.test(e)?(this.$streetNumberField.removeClass("woocommerce-invalid"),this.$streetNumber.is(":focus")||this.performLookup()):this.$streetNumberField.addClass("woocommerce-invalid"))},r.prototype.validateStreetNumberSuffix=function(){const e=this.$streetNumberSuffix.val();this.$message.hide(),i.test(e)?(this.$streetNumberSuffixField.removeClass("woocommerce-invalid"),this.$streetNumberSuffix.is(":focus")||this.performLookup()):this.$streetNumberSuffixField.addClass("woocommerce-invalid")},r.prototype.isValidPostcode=function(){const e=this.$postcode.val();return null!==e&&""!==e&&t.test(e)},r.prototype.isValidStreetNumber=function(){const e=this.$streetNumber.val();return null!==e&&""!==e&&s.test(e)},r.prototype.isValidStreetNumberSuffix=function(){const e=this.$streetNumberSuffix.val();return i.test(e)},r.prototype.markFieldsAsRequired=function(e){e.forEach(e=>{e.find("label").children().remove(),e.addClass("validated-required").find("label").append('<abbr class="required" title="">*</abbr>')})},r.prototype.setHelperElements=function(){this.$spinner=e("<div>",{id:"spikkl-"+this.prefix+"-spinner",class:"spikkl-loader",style:"display:none;"}),this.$message=e("<ul>",{id:"spikkl-"+this.prefix+"-message",class:"woocommerce-error",style:"display:none;"}),this.$postcode.after(this.$spinner),this.$postcode.before(this.$message)},r.prototype.reorderFields=function(e){this.isCountryEligibleForLookup(e)?(this.markFieldsAsRequired([this.$streetField,this.$streetNumberField]),this.$streetField.show(),this.$streetNumberField.show(),this.$streetNumberSuffixField.show(),this.$address1Field.hide(),this.$address2Field.hide(),this.$countryField.after(this.$postcodeField)):(this.$streetField.hide(),this.$streetNumberField.hide(),this.$streetNumberSuffixField.hide(),this.$address1Field.show(),this.$address2Field.show(),this.$cityField.before(this.$postcodeField))},r.prototype.getSelectedCountryCode=function(){return this.$country.val().trim()},r.prototype.isCheckout=function(){return this.$country.length>0&&this.$postcode.length>0&&this.$city.length>0},r.prototype.isCountryEligibleForLookup=function(e){return e=e||this.getSelectedCountryCode(),spikkl_params.supported_countries.indexOf(e)>=0},"undefined"!=typeof spikkl_billing_fields&&new r(spikkl_billing_fields),"undefined"!=typeof spikkl_shipping_fields&&e("#ship-to-different-address-checkbox").length&&new r(spikkl_shipping_fields)});